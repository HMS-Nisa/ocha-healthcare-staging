---
// src/pages/doctor/[id].astro
import Layout from '../../layouts/Layout.astro';
import { MapPin, Building2, Calendar, Globe, Stethoscope, CheckCircle2, ChevronLeft, Info } from 'lucide-react';
import { GOOGLE_SHEET_URL, WA_NUMBER } from '../../config';

// 1. GENERATE STATIC PATHS
export async function getStaticPaths() {
  try {
    // Add timestamp to force fresh data build
    const noCacheUrl = `${GOOGLE_SHEET_URL}?t=${Date.now()}`;
    const response = await fetch(noCacheUrl);
    const data = await response.json();
    
    // Filter out empty rows
    const validDoctors = data.filter(doc => doc.name && doc.id);

    return validDoctors.map(doc => ({
      params: { id: doc.id }, // Using the real ID from your sheet
      props: { doctor: doc }
    }));
  } catch (error) {
    console.error("Error fetching doctors:", error);
    return [];
  }
}

const { doctor } = Astro.props;
const waLink = `https://wa.me/${WA_NUMBER}?text=Hi Ocha, I would like to book an appointment with ${doctor.name} at ${doctor.hospital}`;

// Helper to format languages (replace commas if needed for UI consistency)
const languages = doctor.languages ? doctor.languages.split(',').join(', ') : '-';

// SEO Meta Data
const pageTitle = `${doctor.name} - ${doctor.specialty} in ${doctor.location?.split(',').pop() || 'Malaysia'}`;
const pageDescription = doctor.bio 
  ? doctor.bio.substring(0, 160) + "..." 
  : `Book an appointment with ${doctor.name}, a specialist in ${doctor.specialty} at ${doctor.hospital}.`;

---

<Layout title={pageTitle} description={pageDescription}>
  
  {/* JSON-LD Schema for Google */}
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "Physician",
    "name": doctor.name,
    "medicalSpecialty": doctor.specialty,
    "hospitalAffiliation": {
      "@type": "Hospital",
      "name": doctor.hospital
    },
    "description": doctor.bio
  })} />

  <div class="bg-slate-50 min-h-screen pb-20 pt-28">
    
    {/* BREADCRUMB */}
    <div class="max-w-6xl mx-auto px-4 sm:px-6 mb-8">
      <a href="/doctors" class="inline-flex items-center text-sm font-medium text-slate-500 hover:text-indigo-600 transition-colors">
        <ChevronLeft className="w-4 h-4 mr-1" />
        Back to Directory
      </a>
    </div>

    <div class="max-w-6xl mx-auto px-4 sm:px-6 grid lg:grid-cols-3 gap-8">
      
      {/* LEFT COLUMN: Main Profile */}
      <div class="lg:col-span-2 space-y-6">
        
        {/* HEADER CARD */}
        <div class="bg-white rounded-[2rem] p-8 shadow-sm border border-slate-100 flex flex-col md:flex-row items-start gap-8">
          <div class="relative shrink-0 mx-auto md:mx-0">
             <img 
                src={doctor.image} 
                alt={doctor.name}
                class="w-32 h-32 md:w-40 md:h-40 rounded-full object-cover object-top border-4 border-slate-50 shadow-md bg-slate-100"
                onError={(e) => { e.target.src = 'https://placehold.co/200?text=Dr'; }} 
             />
             <div class="absolute bottom-2 right-2 p-1 bg-green-500 border-4 border-white rounded-full text-white" title="Verified">
                <CheckCircle2 className="w-4 h-4" />
             </div>
          </div>
          
          <div class="flex-1 text-center md:text-left">
            <div class="mb-5">
               <h1 class="font-serif text-3xl md:text-4xl font-bold text-slate-900 mb-3">{doctor.name}</h1>
               
               <div class="flex flex-col items-center md:items-start gap-2">
                 {/* Main Specialty */}
                 <span class="inline-block font-bold text-[#276CA1] uppercase tracking-widest text-xs bg-blue-50 px-3 py-1.5 rounded-lg border border-blue-100">
                    {doctor.specialty}
                 </span>
                 
                 {/* Subspecialty (If exists) */}
                 {doctor.subspecialty && (
                   <span class="font-medium text-slate-500 text-sm flex items-center gap-1">
                     <span class="w-1.5 h-1.5 rounded-full bg-slate-400"></span>
                     {doctor.subspecialty}
                   </span>
                 )}
               </div>
            </div>

            <div class="space-y-2 text-slate-600 border-t border-slate-50 pt-4 mt-4">
               <div class="flex items-center justify-center md:justify-start gap-2">
                 <Building2 className="w-4 h-4 text-slate-400 shrink-0" />
                 <span class="text-sm font-medium">{doctor.hospital}</span>
               </div>
               <div class="flex items-center justify-center md:justify-start gap-2">
                 <MapPin className="w-4 h-4 text-slate-400 shrink-0" />
                 <span class="text-sm font-medium">{doctor.location}</span>
               </div>
               {languages && (
                  <div class="flex items-center justify-center md:justify-start gap-2">
                    <Globe className="w-4 h-4 text-slate-400 shrink-0" />
                    <span class="text-sm font-medium">{languages}</span>
                  </div>
               )}
            </div>
          </div>
        </div>

        {/* ABOUT / BIO SECTION */}
        <div class="bg-white rounded-2xl p-8 shadow-sm border border-slate-100">
           <div class="flex items-center gap-3 mb-6">
             <div class="p-2 bg-blue-50 text-blue-600 rounded-lg">
               <Stethoscope className="w-5 h-5" />
             </div>
             <h2 class="font-serif text-xl font-bold text-slate-900">About the Specialist</h2>
           </div>
           
           {doctor.bio ? (
             <div class="prose prose-slate max-w-none text-slate-600 leading-relaxed whitespace-pre-line">
               {doctor.bio}
             </div>
           ) : (
             <p class="text-slate-400 italic">Profile information is currently being updated.</p>
           )}
        </div>

      </div>

      {/* RIGHT COLUMN: Action & Schedule */}
      <div class="space-y-6">
        
        {/* CTA CARD */}
        <div class="bg-white rounded-2xl p-6 shadow-lg shadow-indigo-900/5 border border-slate-100 sticky top-24">
           <h3 class="font-serif text-lg font-bold text-slate-900 mb-2">Ready to consult?</h3>
           <p class="text-slate-500 text-sm mb-6 leading-relaxed">
             Get a cost estimate and check availability via our concierge.
           </p>
           
           <a 
             href={waLink}
             target="_blank"
             class="block w-full py-3.5 bg-[#276CA1] hover:bg-[#1f5682] text-white text-center font-bold rounded-xl transition-all shadow-md hover:shadow-lg hover:-translate-y-0.5"
           >
             Book Appointment
           </a>

           <div class="mt-8">
              <div class="flex items-center gap-2 mb-4">
                 <Calendar className="w-4 h-4 text-slate-400" />
                 <span class="font-bold text-slate-900 text-sm">Clinic Schedule</span>
              </div>
              
              <div class="space-y-3">
                 {/* SCHEDULE LOGIC: Check if real array exists */}
                 {Array.isArray(doctor.schedule) && doctor.schedule.length > 0 ? (
                    doctor.schedule.map((slot, i) => (
                      <div key={i} class="flex justify-between items-center text-sm p-3 rounded-lg bg-slate-50 border border-slate-100">
                          <span class="font-medium text-slate-700">{slot.day}</span>
                          <span class="text-slate-500 font-medium">{slot.time}</span>
                      </div>
                    ))
                 ) : (
                    <div class="p-4 bg-slate-50 rounded-lg text-center">
                        <Info className="w-5 h-5 text-slate-400 mx-auto mb-2" />
                        <span class="text-xs text-slate-500">Contact us for availability.</span>
                    </div>
                 )}
              </div>
              <p class="text-[10px] text-slate-400 mt-4 text-center">Schedules are subject to change.</p>
           </div>
        </div>

      </div>

    </div>
  </div>
</Layout>